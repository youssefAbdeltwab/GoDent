@model GoDent.DAL.Entities.Doctor

@{
    ViewData["Title"] = "تفاصيل الطبيب";
    var treatments = Model.Treatments.OrderByDescending(t => t.TreatmentDate).ToList();
    decimal totalCost = ViewBag.TotalCost;
    decimal totalLabCost = ViewBag.TotalLabCost;
    decimal totalNet = ViewBag.TotalNet;
    decimal totalDoctorShare = ViewBag.TotalDoctorShare;
    decimal totalClinicShare = ViewBag.TotalClinicShare;
}

<div class="d-flex justify-content-between align-items-center mb-4">
    <h2><i class="fas fa-user-md"></i> تفاصيل الطبيب</h2>
    <a asp-action="Index" class="btn btn-secondary">
        <i class="fas fa-arrow-right"></i> رجوع للقائمة
    </a>
</div>

@if (TempData["Success"] != null)
{
    <div class="alert alert-success alert-dismissible fade show">
        @TempData["Success"]
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
}

<!-- Doctor Info Card -->
<div class="card mb-4">
    <div class="card-header bg-primary text-white">
        <h5 class="mb-0"><i class="fas fa-id-card"></i> بيانات الطبيب</h5>
    </div>
    <div class="card-body">
        <div class="row">
            <div class="col-md-6">
                <dl class="row">
                    <dt class="col-sm-4">الاسم:</dt>
                    <dd class="col-sm-8">@Model.FullName</dd>

                    <dt class="col-sm-4">رقم الهاتف:</dt>
                    <dd class="col-sm-8">
                        <a href="tel:@Model.PhoneNumber" class="text-decoration-none">@Model.PhoneNumber</a>
                    </dd>
                </dl>
            </div>
            <div class="col-md-6">
                <dl class="row">
                    <dt class="col-sm-4">التخصص:</dt>
                    <dd class="col-sm-8">@(Model.Specialization ?? "---")</dd>

                    <dt class="col-sm-4">الحالة:</dt>
                    <dd class="col-sm-8">
                        @if (Model.IsActive)
                        {
                            <span class="badge bg-success">نشط</span>
                        }
                        else
                        {
                            <span class="badge bg-secondary">غير نشط</span>
                        }
                    </dd>
                </dl>
            </div>
        </div>
    </div>
</div>

<!-- Financial Summary Card (Doctor Salary) -->
<div class="card mb-4 border-warning">
    <div class="card-header bg-warning text-dark">
        <h5 class="mb-0"><i class="fas fa-coins"></i> ملخص المستحقات (الراتب)</h5>
    </div>
    <div class="card-body">
        <div class="row text-center">
            <div class="col-md-3">
                <div class="border rounded p-3">
                    <h6 class="text-muted">إجمالي التكلفة</h6>
                    <h4 class="text-primary">@totalCost.ToString("N2") ج.م</h4>
                </div>
            </div>
            <div class="col-md-2">
                <div class="border rounded p-3">
                    <h6 class="text-muted">تكلفة المعامل</h6>
                    <h4 class="text-danger">@totalLabCost.ToString("N2") ج.م</h4>
                </div>
            </div>
            <div class="col-md-2">
                <div class="border rounded p-3">
                    <h6 class="text-muted">الصافي</h6>
                    <h4 class="text-info">@totalNet.ToString("N2") ج.م</h4>
                </div>
            </div>
            <div class="col-md-3">
                <div class="border rounded p-3 bg-warning bg-opacity-10">
                    <h6 class="text-muted">مستحقات الطبيب (40%)</h6>
                    <h4 class="text-warning fw-bold">@totalDoctorShare.ToString("N2") ج.م</h4>
                </div>
            </div>
            <div class="col-md-2">
                <div class="border rounded p-3">
                    <h6 class="text-muted">نصيب العيادة (60%)</h6>
                    <h4 class="text-success">@totalClinicShare.ToString("N2") ج.م</h4>
                </div>
            </div>
        </div>
        <div class="row mt-3">
            <div class="col-12 text-center">
                <span class="text-muted">عدد العلاجات: <strong>@treatments.Count</strong></span>
            </div>
        </div>
    </div>
</div>

<!-- Treatments Section -->
<div class="d-flex justify-content-between align-items-center mb-3">
    <h4><i class="fas fa-tooth"></i> العلاجات (@treatments.Count)</h4>
</div>

@if (!treatments.Any())
{
    <div class="alert alert-info">
        <i class="fas fa-info-circle"></i> لا توجد علاجات مسجلة لهذا الطبيب.
    </div>
}
else
{
    <div class="card">
        <div class="card-body">
            <div class="table-responsive">
                <table id="treatmentsTable" class="table table-striped table-hover table-bordered">
                    <thead class="table-dark">
                        <tr>
                            <th style="width: 50px;">#</th>
                            <th>المريض</th>
                            <th style="width: 80px;">رقم السن</th>
                            <th>وصف العلاج</th>
                            <th style="width: 100px;">التكلفة</th>
                            <th style="width: 100px;">المعمل</th>
                            <th style="width: 100px;">الصافي</th>
                            <th style="width: 100px;">الطبيب 40%</th>
                            <th style="width: 100px;">العيادة 60%</th>
                            <th style="width: 110px;">التاريخ</th>
                        </tr>
                    </thead>
                    <tbody>
                        @{ int counter = 1; }
                        @foreach (var treatment in treatments)
                        {
                            <tr>
                                <td class="text-center">@(counter++)</td>
                                <td>
                                    <a asp-controller="Patients" asp-action="Details" asp-route-id="@treatment.PatientId"
                                       class="text-decoration-none">
                                        <i class="fas fa-user"></i> @(treatment.Patient?.FullName ?? "---")
                                    </a>
                                </td>
                                <td class="text-center">
                                    @if (treatment.ToothNumber.HasValue)
                                    {
                                        <span class="badge bg-info">@treatment.ToothNumber</span>
                                    }
                                    else
                                    {
                                        <span class="text-muted">---</span>
                                    }
                                </td>
                                <td>@treatment.Description</td>
                                <td class="text-center">@treatment.Cost.ToString("N2")</td>
                                <td class="text-center">
                                    @if (treatment.HasLabCost && treatment.LabCost.HasValue)
                                    {
                                        <span class="text-danger">@treatment.LabCost.Value.ToString("N2")</span>
                                    }
                                    else
                                    {
                                        <span class="text-muted">---</span>
                                    }
                                </td>
                                <td class="text-center fw-bold">@treatment.NetCost.ToString("N2")</td>
                                <td class="text-center text-warning">@treatment.DoctorShare.ToString("N2")</td>
                                <td class="text-center text-success">@treatment.ClinicShare.ToString("N2")</td>
                                <td class="text-center">@treatment.TreatmentDate.ToString("yyyy-MM-dd")</td>
                            </tr>
                        }
                    </tbody>
                    <tfoot>
                        <tr class="table-warning fw-bold">
                            <td colspan="4" class="text-end">الإجمالي:</td>
                            <td class="text-center">@totalCost.ToString("N2")</td>
                            <td class="text-center">@totalLabCost.ToString("N2")</td>
                            <td class="text-center">@totalNet.ToString("N2")</td>
                            <td class="text-center">@totalDoctorShare.ToString("N2")</td>
                            <td class="text-center">@totalClinicShare.ToString("N2")</td>
                            <td></td>
                        </tr>
                    </tfoot>
                </table>
            </div>
        </div>
    </div>
}

@section Scripts {
    <script>
        $(document).ready(function () {
            $('#treatmentsTable').DataTable({
                language: {
                    url: '//cdn.datatables.net/plug-ins/1.13.6/i18n/ar.json'
                },
                order: [[9, 'desc']],
                pageLength: 25
            });
        });
    </script>
}
